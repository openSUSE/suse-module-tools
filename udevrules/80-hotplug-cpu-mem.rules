# Do not edit this file under /usr/lib/udev/rules.d, it will be overwritten on update
# If you need modifications, copy it to /etc/udev/rules.d and edit it there

ACTION!="add", GOTO="hotplug_cpu_end"
SUBSYSTEM!="cpu|memory", GOTO="hotplug_cpu_end"

#
# Hotplug physical CPU
#
SUBSYSTEM=="cpu", CONST{arch}=="x86-64", TEST=="online", ATTR{online}=="0", ATTR{online}="1"
SUBSYSTEM=="cpu", CONST{arch}=="s390*", TEST=="online", ATTR{configure}=="1", ATTR{online}=="0", ATTR{online}="1"

#
# Hotplug physical memory. Instances of tmpfs are remounted so their
# size are recalculated. This might be needed if some sizes were
# specified relative to the total amount of memory (boo#869603). For
# now make it simple and remount all tmpfs regardless of how their
# size are specified. It should be handled by the kernel as it has a
# lot of shortcomings anyways (tmpfs mounted by other processes, mount
# namespaces, ...)
#
SUBSYSTEM=="memory", CONST{arch}!="s390x", ATTR{state}=="offline", ATTR{state}="online", \
  RUN+="/bin/sh -c ' \
    while read src dst fs opts unused; do \
      case $$fs in \
      tmpfs)  mount -o remount \"$$dst\" ;; \
      esac \
    done </proc/self/mounts"

LABEL="hotplug_cpu_end"
